@using System.Security.Claims
@model Dental_Clinic_System.ViewModels.PatientVM
@{
    ViewData["Title"] = "Profile";
    // var firstname = Context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Surname)?.Value;

    // var lastname = Context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.GivenName)?.Value;

    // var mobilePhone = Context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.MobilePhone)?.Value;

    // var email = Context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Email)?.Value;

    // var gender = Context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Gender)?.Value;

    // var address = Context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.StreetAddress)?.Value;
    // if (mobilePhone is null) Console.WriteLine("NO mobilephone");
}


<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dental Care | login</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Paaji+2:wght@400..800&display=swap"
          rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous" />
    <link rel="stylesheet" href="~/assets/css/header.css" />
    <link rel="stylesheet" href="~/assets/css/footer.css" />
    <link rel="stylesheet" href="~/assets/css/profile.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <main>
        <div class="profile">
            <div class="d-flex">
                <ul class="nav sidebar">
                    <li>
                        <a class="nav-link active" data-bs-toggle="tab" href="#account">Quản lý tài khoản</a>
                    </li>
                    @if (User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == false)
                    {
                        <li>
                            <a class="nav-link" data-bs-toggle="tab" href="#repass">Đổi mật khẩu</a>
                        </li>
                    }
                    <li>
                        <a class="nav-link" data-bs-toggle="tab" href="#history">Lịch sử đặt khám</a>
                    </li>
                </ul>
                <div class="profile__content tab-content">
                    <div id="account" class="tab-pane fade show active">
                        <h2>Quản lý tài khoản</h2>
                        @if (TempData["ChangePasswordMessageSuccessfully"] != null)
                        {
                            <div class="alert alert-success">
                                @TempData["ChangePasswordMessageSuccessfully"]
                            </div>
                        }

                        @if (TempData["ChangePasswordMessageFailed"] != null)
                        {
                            <div class="alert alert-danger">
                                @TempData["ChangePasswordMessageFailed"]
                            </div>
                        }

                        @if (TempData["EmailError"] != null)
                        {
                            <div class="alert alert-danger">
                                @TempData["EmailError"]
                            </div>
                        }

                        @if (TempData["PhoneNumberError"] != null)
                        {
                            <div class="alert alert-danger">
                                @TempData["PhoneNumberError"]
                            </div>
                        }

                        @if (TempData["EmailChangeMessage"] != null)
                        {
                            <div class="alert alert-info">
                                @TempData["EmailChangeMessage"]
                            </div>
                        }

                        <div class="profile__warn">(*) Thông tin bắt buộc nhập</div>
                        <form asp-action="profile" method="POST" class="d-flex account__content__wrapper">
                            <div style="width: 50%">
                                <label for="firstname">Họ <sup>*</sup></label><br /><input type="text"
                                                                                           id="firstname"
                                                                                           placeholder="Họ"
                                                                                           value="@Model.FirstName"
                                                                                           asp-for="@Model.FirstName"
                                                                                           style="width: 100%" />
                            </div>
                            <div style="width: 50%">
                                <label for="lastname">Tên <sup>*</sup></label><br /><input type="text"
                                                                                           id="lastname"
                                                                                           placeholder="Tên"
                                                                                           value="@Model.LastName"
                                                                                           asp-for="@Model.LastName"
                                                                                           style="width: 100%" />
                            </div>
                            <div style="width: 50%">
                                <label for="phone">Số điện thoại <sup>*</sup></label><br /><input type="text"
                                                                                                  id="phone"
                                                                                                  placeholder="Vui lòng nhập số điện thoại ..."
                                                                                                  pattern="[0-9]*"
                                                                                                  value="@Model.PhoneNumber"
                                                                                                  asp-for="@Model.PhoneNumber"
                                                                                                  style="width: 100%" />

                            </div>
                            <div style="width: 50%">
                                <label for="gender">Giới tính <sup>*</sup></label><br />
                                <select id="gender" asp-for="@Model.Gender" style="width: 100%">

                                    @* Tạo các thẻ option động bằng Razor *@
                                    @if (Model.Gender == "Nam")
                                    {
                                        <option value=null disabled>Chọn giới tính ...</option>
                                        <option value="Nam" selected>Nam</option>
                                        <option value="Nữ">Nữ</option>
                                    }
                                    else if (Model.Gender == "Nữ")
                                    {
                                        <option value=null disabled>Chọn giới tính ...</option>
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ" selected>Nữ</option>
                                    }
                                    else
                                    {
                                        <option value=null disabled selected>Chọn giới tính ...</option>
                                        <option value="Nam">Nam</option>
                                        <option value="Nữ">Nữ</option>
                                    }
                                </select>
                            </div>
                            @if (User.Identity.IsAuthenticated && ((User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == true) || (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "IsLinkedWithGoogle") == true)
                            {
                                <div style="width: 50%">
                                    <label for="mail">Email <sup>*</sup></label><br /><input type="email"
                                                                                             id="mail"
                                                                                             placeholder="Nhập địa chỉ email để nhận thông tin lịch khám"
                                                                                             value="@Model.Email"
                                                                                             asp-for="@Model.Email"
                                                                                             readonly
                                                                                             style="width: 100%" />

                                </div>
                            }
                            else
                            {
                                <div style="width: 50%">
                                    <label for="mail">Email <sup>*</sup></label><br /><input type="email"
                                                                                             id="mail"
                                                                                             placeholder="Nhập địa chỉ email để nhận thông tin lịch khám"
                                                                                             value="@Model.Email"
                                                                                             asp-for="@Model.Email"
                                                                                             style="width: 100%" />

                                </div>
                            }

                            <div style="width: 50%">
                                <label for="birth">Ngày sinh <sup>*</sup></label><br /><input type="date"
                                                                                              id="birth"
                                                                                              value="@(Model.DateOfBirth.HasValue ? Model.DateOfBirth.Value.ToString("yyyy-MM-dd") : string.Empty)"
                                                                                              asp-for="@Model.DateOfBirth"
                                                                                              max="@DateTime.Now.AddYears(-16).ToString("yyyy-MM-dd")"
                                                                                              placeholder="Vui lòng nhập ngày sinh"
                                                                                              style="width: 100%" />
                            </div>

                            <div style="width: 50%">
                                <label for="province">Tỉnh / Thành phố <sup>*</sup></label><br />
                                <select id="tinh" title="Chọn Tỉnh Thành" asp-for="@Model.Province">
                                    <option value="0">Tỉnh Thành</option>
                                </select>
                            </div>
                            <div style="width: 25%" class="district">
                                <label for="district">Quận / Huyện <sup>*</sup></label><br />
                                <select id="quan" title="Chọn Quận Huyện" asp-for="@Model.District">
                                    <option value="0">Quận Huyện</option>
                                </select>
                            </div>
                            <div style="width: 25%" class="ward">
                                <label for="ward">Phường / Xã <sup>*</sup></label><br />
                                <select id="phuong" title="Chọn Phường Xã" asp-for="@Model.Ward">
                                    <option value="0">Phường Xã</option>
                                </select>
                            </div>

                            <div style="width: 100%" class="address">
                                <label for="address">Địa chỉ <sup>*</sup></label><br /><input type="text"
                                                                                              id="address"
                                                                                              placeholder="Nhập địa chỉ"
                                                                                              value="@Model.Address"
                                                                                              asp-for="@Model.Address"
                                                                                              style="width: 100%" />
                            </div>
                            <div class="submit__button">
                                <button type="reset" class="reset">Nhập lại</button>
                                <button type="submit" class="submit">Lưu</button>
                            </div>
                        </form>
                    </div>
                    @if (User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == false)
                    {
                        <div id="repass" class="tab-pane fade">
                            <h2>Đổi mật khẩu</h2>
                            <div class="repass__content__wrapper">
                                <form asp-action="ChangePassword" method="POST">
                                    <div style="width: 100%">
                                        <label for="pass">Mật khẩu</label><br /><input type="password"
                                                                                       name="password"
                                                                                       id="pass"
                                                                                       placeholder="Nhập mật khẩu"
                                        @(User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == true ? "readonly" : "required")
                                                                                       style="width: 100%" />
                                    </div>
                                    <div style="width: 100%">
                                        <label for="firstname">Mật khẩu mới</label><br /><input type="password"
                                                                                                name="newPassword"
                                                                                                id="firstname"
                                                                                                placeholder="Nhập mật khẩu mới"
                                        @(User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == true ? "readonly" : "required")
                                                                                                style="width: 100%" />
                                    </div>
                                    <div style="width: 100%">
                                        <label for="firstname">Nhập lại mật khẩu</label><br /><input type="password"
                                                                                                     name="confirmPassword"
                                                                                                     id="firstname"
                                                                                                     placeholder="Nhập lại mật khẩu"
                                        @(User.Identity.IsAuthenticated && (User.Identity as ClaimsIdentity)?.Claims.Any(c => c.Issuer == "Google") == true ? "readonly" : "required")
                                                                                                     style="width: 100%" />
                                    </div>
                                    <div class="submit__button">
                                        <button type="reset" class="reset">Nhập lại</button>
                                        <button type="submit" class="submit">Tạo mới</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    }
                    <div id="history" class="tab-pane fade">
                        <h2>Lịch sử đặt khám</h2>
                        <div class="history__management">
                            <table class="table table-striped" style="font-size: 2rem">
                                <thead>
                                    <tr>
                                        <th style="text-align: center">STT</th>
                                        <th>Nha sĩ</th>
                                        <th>Chuyên Khoa</th>
                                        <th>Ngày hẹn</th>
                                        <th>Giờ hẹn</th>
                                        <th>Giá tiền</th>
                                        <th>Trạng thái</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr style="vertical-align: middle">
                                        <td style="text-align: center">1</td>
                                        <td>Hoà</td>
                                        <td>Nha khoa tổng quát</td>
                                        <td>2024-05-22</td>
                                        <td>10:00-10:30</td>
                                        <td>10.000.000</td>
                                        <td><p class="status">Chờ xác nhận</p></td>
                                    </tr>

                                    <tr style="vertical-align: middle">
                                        <td style="text-align: center">2</td>
                                        <td>Hoà</td>
                                        <td>Nha khoa tổng quát</td>
                                        <td>2024-05-22</td>
                                        <td>10:00-10:30</td>
                                        <td>10.000.000</td>
                                        <td><p class="status complete">Đã khám</p></td>
                                    </tr>

                                    <tr style="vertical-align: middle">
                                        <td style="text-align: center">3</td>
                                        <td>Hoà</td>
                                        <td>Nha khoa tổng quát</td>
                                        <td>2024-05-22</td>
                                        <td>10:00-10:30</td>
                                        <td>10.000.000</td>
                                        <td><p class="status deny">Huỷ Khám</p></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/53f42380b0.js"
            crossorigin="anonymous"></script>

    @* Call API from https://esgoo.ne to get data*@
    <script src="https://esgoo.net/scripts/jquery.js"></script>
    <script>
        $(document).ready(function () {
            var savedProvince = '@Model.Province';
            var savedDistrict = '@Model.District';
            var savedWard = '@Model.Ward';

            // Chuyển đổi giá trị chuỗi sang số
            var savedProvinceId = parseInt(savedProvince, 10);
            var savedDistrictId = parseInt(savedDistrict, 10);
            var savedWardId = parseInt(savedWard, 10);

            function loadWards(idquan, callback) {
                $.getJSON('https://esgoo.net/api-tinhthanh/3/' + idquan + '.htm', function (data_phuong) {
                    if (data_phuong.error == 0) {
                        $("#phuong").html('<option value="0">Phường Xã</option>');
                        $.each(data_phuong.data, function (key_phuong, val_phuong) {
                            var selected = (val_phuong.id == savedWardId) ? ' selected' : '';
                            $("#phuong").append('<option value="' + val_phuong.id + '" data-fullname="' + val_phuong.full_name + '"' + selected + '>' + val_phuong.full_name + '</option>');
                        });

                        if (callback) {
                            callback();
                        }
                    }
                });
            }

            function loadDistricts(idtinh, callback) {
                $.getJSON('https://esgoo.net/api-tinhthanh/2/' + idtinh + '.htm', function (data_quan) {
                    if (data_quan.error == 0) {
                        $("#quan").html('<option value="0">Quận Huyện</option>');
                        $("#phuong").html('<option value="0">Phường Xã</option>');
                        $.each(data_quan.data, function (key_quan, val_quan) {
                            var selected = (val_quan.id == savedDistrictId) ? ' selected' : '';
                            $("#quan").append('<option value="' + val_quan.id + '" data-fullname="' + val_quan.full_name + '"' + selected + '>' + val_quan.full_name + '</option>');
                        });

                        if (savedDistrictId) {
                            loadWards(savedDistrictId, callback);
                        } else if (callback) {
                            callback();
                        }
                    }
                });
            }

            function loadProvinces(callback) {
                $.getJSON('https://esgoo.net/api-tinhthanh/1/0.htm', function (data_tinh) {
                    if (data_tinh.error == 0) {
                        $("#tinh").html('<option value="0">Tỉnh Thành</option>');
                        $.each(data_tinh.data, function (key_tinh, val_tinh) {
                            var selected = (val_tinh.id == savedProvinceId) ? ' selected' : '';
                            $("#tinh").append('<option value="' + val_tinh.id + '" data-fullname="' + val_tinh.full_name + '"' + selected + '>' + val_tinh.full_name + '</option>');
                        });

                        if (savedProvinceId) {
                            loadDistricts(savedProvinceId, callback);
                        } else if (callback) {
                            callback();
                        }
                    }
                });
            }

            function setInitialValues() {
                if (savedProvinceId) {
                    $("#tinh").val(savedProvinceId);
                    $("#tinh").trigger('change');
                }
                if (savedDistrictId) {
                    $("#quan").val(savedDistrictId);
                    $("#quan").trigger('change');
                }
                if (savedWardId) {
                    $("#phuong").val(savedWardId);
                }
            }

            loadProvinces(setInitialValues);

            $("#tinh").change(function (e) {
                var selectedOption = $(this).find('option:selected');
                var idtinh = selectedOption.val();
                var fullnameTinh = selectedOption.data('fullname');
                $('#Province').val(fullnameTinh);

                // Load districts based on selected province
                loadDistricts(idtinh);
            });

            $("#quan").change(function (e) {
                var selectedOption = $(this).find('option:selected');
                var idquan = selectedOption.val();
                var fullnameQuan = selectedOption.data('fullname');
                $('#District').val(fullnameQuan);

                // Load wards based on selected district
                loadWards(idquan);
            });

            $("#phuong").change(function (e) {
                var selectedOption = $(this).find('option:selected');
                var fullnamePhuong = selectedOption.data('fullname');
                $('#Ward').val(fullnamePhuong);
            });
        });
    </script>
</body>
